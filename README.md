# Solu√ß√£o do Desafio T√©cnico - Pipeline de Dados EX-001

## üéØ Objetivo

Desenvolver um pipeline completo para monitoramento de OEE (Overall Equipment Effectiveness) da m√°quina EX-001, incluindo:

- ‚úÖ Ingest√£o de dados via MQTT
- ‚úÖ Armazenamento em PostgreSQL  
- ‚úÖ Visualiza√ß√£o de KPIs no Grafana

## üèóÔ∏è Arquitetura da Solu√ß√£o

```
MQTT Broker ‚îÄ‚îÄ‚Üí Python Ingestion ‚îÄ‚îÄ‚Üí PostgreSQL ‚îÄ‚îÄ‚Üí Grafana Dashboard
(EcoPlus)       (Container)           (Container)     (Container)
```

### Componentes:

1. **MQTT Broker Externo**: `mqtt.ecoplus-apps.com`
2. **Servi√ßo de Ingest√£o**: Container Python com paho-mqtt
3. **Banco de Dados**: PostgreSQL com esquema otimizado
4. **Visualiza√ß√£o**: Grafana com dashboard OEE pr√©-configurado

## üöÄ Como Executar

### 1. Configura√ß√£o Inicial

```bash
# Clone o reposit√≥rio (se necess√°rio)
git clone https://github.com/sejodrope/desasfio-tecnico-backend
cd desafio-tecnico-backend

# O arquivo .env j√° est√° configurado com as credenciais fornecidas
```

### 2. Iniciar os Servi√ßos

```bash
# Construir e iniciar todos os containers
docker-compose up --build

# Para executar em background
docker-compose up --build -d
```

### 3. Verificar os Servi√ßos

- **PostgreSQL**: Porta 5432
- **Grafana**: http://localhost:3000 (admin/ecoadmin)
- **Logs de Ingest√£o**: `docker-compose logs ingestion`


## üìä KPIs Implementados

O dashboard do Grafana inclui todos os KPIs solicitados:

### 1. **Disponibilidade** üü¢
- **F√≥rmula**: `(Tempo sem paradas / Tempo total) √ó 100`
- **Crit√©rio**: M√°quina ligada, sem manuten√ß√µes
- **Meta**: > 85% (verde), 70-85% (amarelo), < 70% (vermelho)

### 2. **Performance** üîµ  
- **F√≥rmula**: `(Pe√ßas boas/hora / Meta produ√ß√£o) √ó 100`
- **Meta de Produ√ß√£o**: 100 pe√ßas/hora
- **Crit√©rio**: Apenas durante opera√ß√£o ativa

### 3. **Qualidade** üü°
- **F√≥rmula**: `(Pe√ßas boas / Pe√ßas produzidas) √ó 100`
- **Meta**: > 95% (verde), 90-95% (amarelo), < 90% (vermelho)

### 4. **OEE** üèÜ
- **F√≥rmula**: `Disponibilidade √ó Performance √ó Qualidade`
- **Benchmark**: > 85% (classe mundial), 60-85% (bom), < 60% (precisa melhorar)

### 5. **Totalizadores** üìà
- **Total de Pe√ßas Produzidas**: Soma no per√≠odo selecionado
- **Total de Pe√ßas Defeituosas**: Soma no per√≠odo selecionado

### 6. **Gr√°ficos Temporais** üìâ
- **Status da M√°quina**: Timeline com estados (opera√ß√£o, manuten√ß√£o, parada, desligada)
- **Produ√ß√£o por Hora**: Barras com produ√ß√£o total, defeituosas e boas
- **Efici√™ncia por Per√≠odo**: Qualidade % e performance por hora

## üîß Detalhes T√©cnicos

### Estrutura do Banco de Dados

```sql
CREATE TABLE dados_maquina (
  id SERIAL PRIMARY KEY,
  id_maquina INTEGER NOT NULL,
  datahora TIMESTAMPTZ NOT NULL,
  ligada BOOLEAN,
  operacao BOOLEAN,
  manutencao_corretiva BOOLEAN,
  manutencao_preventiva BOOLEAN,
  pecas_produzidas INTEGER,
  pecas_defeituosas INTEGER
);

-- √çndice para otimizar consultas temporais
CREATE INDEX idx_dados_maquina_datahora ON dados_maquina(datahora);
```

### Formato das Mensagens MQTT

```json
{
  "id_maquina": 1,
  "datahora": "2025-01-01T12:00:00-03:00",
  "ligada": true,
  "operacao": true,
  "manutencao_corretiva": false,
  "manutencao_preventiva": false,
  "pecas_produzidas": 9,
  "pecas_defeituosas": 1
}
```

### Melhorias Implementadas

1. **Logs Detalhados**: Emojis e informa√ß√µes claras sobre o processo
2. **Valida√ß√£o de Dados**: Verifica√ß√£o de campos obrigat√≥rios
3. **Tratamento de Erros**: Retry autom√°tico para conex√£o DB
4. **Toler√¢ncia a Falhas**: Reconex√£o autom√°tica MQTT
5. **Timezone**: Suporte a fuso hor√°rio brasileiro
6. **Dashboard Responsivo**: Interface otimizada para diferentes telas

## üìà Queries SQL dos KPIs

### Disponibilidade
```sql
WITH tempo_total AS (
  SELECT EXTRACT(EPOCH FROM (MAX(datahora) - MIN(datahora))) / 3600 AS horas_periodo
  FROM dados_maquina WHERE $__timeFilter(datahora)
),
tempo_disponivel AS (
  SELECT EXTRACT(EPOCH FROM SUM(
    CASE 
      WHEN ligada = true AND manutencao_corretiva = false AND manutencao_preventiva = false 
      THEN INTERVAL '5 minutes'
      ELSE INTERVAL '0'
    END
  )) / 3600 AS horas_disponivel
  FROM dados_maquina WHERE $__timeFilter(datahora)
)
SELECT 
  CASE 
    WHEN tt.horas_periodo > 0 
    THEN ROUND((td.horas_disponivel / tt.horas_periodo * 100)::numeric, 2)
    ELSE 0
  END AS disponibilidade
FROM tempo_total tt, tempo_disponivel td;
```

### Performance
```sql
WITH producao_real AS (
  SELECT 
    SUM(pecas_produzidas - pecas_defeituosas) AS pecas_boas,
    EXTRACT(EPOCH FROM (MAX(datahora) - MIN(datahora))) / 3600 AS horas_periodo
  FROM dados_maquina 
  WHERE $__timeFilter(datahora) AND operacao = true
)
SELECT 
  CASE 
    WHEN horas_periodo > 0 
    THEN ROUND(((pecas_boas / horas_periodo) / 100 * 100)::numeric, 2)
    ELSE 0
  END AS performance
FROM producao_real;
```

### Qualidade
```sql
WITH qualidade_calc AS (
  SELECT 
    SUM(pecas_produzidas) AS total_produzidas,
    SUM(pecas_produzidas - pecas_defeituosas) AS pecas_boas
  FROM dados_maquina 
  WHERE $__timeFilter(datahora)
)
SELECT 
  CASE 
    WHEN total_produzidas > 0 
    THEN ROUND((pecas_boas::float / total_produzidas * 100)::numeric, 2)
    ELSE 0
  END AS qualidade
FROM qualidade_calc;
```

## üé® Dashboard Features

- **Refresh Autom√°tico**: 30 segundos
- **Time Picker**: Sele√ß√£o flex√≠vel de per√≠odo
- **Cores Semaf√≥ricas**: Verde/Amarelo/Vermelho baseado em thresholds
- **Tooltips Informativos**: Detalhes sobre cada m√©trica
- **Layouts Responsivos**: Adapta√ß√£o a diferentes resolu√ß√µes

## üîç Monitoramento e Debug

### Verificar Logs dos Containers

```bash
# Logs da ingest√£o MQTT
docker-compose logs -f ingestion

# Logs do PostgreSQL
docker-compose logs -f postgres

# Logs do Grafana
docker-compose logs -f grafana
```

### Verificar Dados no Banco

```bash
# Conectar ao PostgreSQL
docker-compose exec postgres psql -U admin -d ex001

# Consultar dados recentes
SELECT * FROM dados_maquina ORDER BY datahora DESC LIMIT 10;

# Verificar contagem de registros
SELECT COUNT(*) FROM dados_maquina;
```

### Testar Conex√£o MQTT

Use o **MQTT Explorer** ou cliente similar:
- **Host**: mqtt.ecoplus-apps.com
- **Port**: 1883
- **Username**: ecoplus-teste:temp_user
- **Password**: u9JJ8d8DOp
- **Topic**: ECOPLUS/EX-001/dados

## üö® Troubleshooting

### Problema: Containers n√£o iniciam
```bash
# Verificar logs
docker-compose logs

# Recriar containers
docker-compose down -v
docker-compose up --build
```

### Problema: N√£o recebe dados MQTT
1. Verificar credenciais no `.env`
2. Testar conectividade com MQTT Explorer
3. Verificar logs do container ingestion

### Problema: Dashboard vazio
1. Verificar se h√° dados no banco (executar a query)
2. Ajustar time range no Grafana
3. Verificar conex√£o do datasource PostgreSQL


---

**Desenvolvido por**: Jos√© Pedro  
**Desafio**: ECO+ Automa√ß√£o - Vaga Backend
